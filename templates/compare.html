{% extends "base.html" %}

{% block title %}Comparison Tools - TumorVision{% endblock %}

{% block content %}
<div class="glass" style="padding: 3rem; border-radius: 20px; max-width: 1200px; margin: 0 auto; margin-top: 2rem;">
    <h2 style="margin-bottom: 3rem; text-align: center;">Advanced Analysis Tools</h2>

    <!-- SECTION 1: 3D VOLUME COMPARISON -->
    <div style="margin-bottom: 4rem; padding-bottom: 3rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <h3 style="margin-bottom: 1rem; color: var(--secondary);"><i class="fa-solid fa-cube"></i> &nbsp;3D Volume
            Comparison</h3>
        <p style="color: var(--text-muted); margin-bottom: 2rem;">
            Upload two **NIfTI (.nii)** files to compare the maximum tumor burden slice side-by-side.
        </p>

        <form id="compare3DForm">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; margin-bottom: 2rem;">
                <!-- Patient 1 -->
                <div style="flex: 1; min-width: 300px;">
                    <div class="upload-area" id="dropZone1" style="height: 120px;">
                        <i class="fa-solid fa-file-medical upload-icon"
                            style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p>Select NIfTI 1</p>
                        <input type="file" name="file1" id="fileInput1" accept=".nii,.nii.gz"
                            style="opacity: 0; position: absolute; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
                    </div>
                    <p id="fileName1"
                        style="text-align: center; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                    </p>
                </div>

                <!-- Patient 2 -->
                <div style="flex: 1; min-width: 300px;">
                    <div class="upload-area" id="dropZone2" style="height: 120px;">
                        <i class="fa-solid fa-file-medical upload-icon"
                            style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p>Select NIfTI 2</p>
                        <input type="file" name="file2" id="fileInput2" accept=".nii,.nii.gz"
                            style="opacity: 0; position: absolute; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
                    </div>
                    <p id="fileName2"
                        style="text-align: center; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                    </p>
                </div>
            </div>

            <div style="text-align: center;">
                <button type="submit" class="btn btn-primary" id="compare3DBtn" disabled>Compare 3D Volumes</button>
            </div>
        </form>

        <div class="loader" id="loader3D"></div>

        <div id="result3D" style="margin-top: 2rem; display: none; text-align: center;">
            <div style="background: #000; border-radius: 8px; overflow: hidden; display: inline-block;">
                <img id="compareImage3D" src="" alt="Comparison Result"
                    style="max-width: 100%; height: auto; display: block;">
            </div>
            <!-- Legend -->
            <div style="margin-top: 1.5rem; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span
                        style="width: 12px; height: 12px; background-color: #ef4444; border-radius: 50%; display: inline-block;"></span>
                    <span style="font-size: 0.9rem; color: #ef4444;">Enhancing Tumor</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span
                        style="width: 12px; height: 12px; background-color: #eab308; border-radius: 50%; display: inline-block;"></span>
                    <span style="font-size: 0.9rem; color: #eab308;">Edema</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span
                        style="width: 12px; height: 12px; background-color: #22d3ee; border-radius: 50%; display: inline-block;"></span>
                    <span style="font-size: 0.9rem; color: #22d3ee;">Necrotic</span>
                </div>
            </div>
            <!-- Slice Info -->
            <div id="sliceInfo3D"
                style="margin-top: 1rem; text-align: center; color: var(--text-muted); font-size: 0.9rem; display: none;">
                <span id="p1Slice">Patient 1: z=--</span> &nbsp;|&nbsp; <span id="p2Slice">Patient 2: z=--</span>
            </div>
        </div>
    </div>


    <!-- SECTION 2: 2D GRAD-CAM COMPARISON -->
    <div>
        <h3 style="margin-bottom: 1rem; color: var(--primary);"><i class="fa-solid fa-fire"></i> &nbsp;2D Grad-CAM
            Heatmap Comparison</h3>
        <p style="color: var(--text-muted); margin-bottom: 2rem;">
            Upload two **2D Images (.jpg, .png)** to visualize class activation heatmaps (Grad-CAM).
        </p>

        <form id="compare2DForm">
            <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center; margin-bottom: 2rem;">
                <!-- Image 1 -->
                <div style="flex: 1; min-width: 300px;">
                    <div class="upload-area" id="dropZone2D1" style="height: 120px;">
                        <i class="fa-regular fa-image upload-icon"
                            style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p>Select Image 1</p>
                        <input type="file" name="file1" id="fileInput2D1" accept=".jpg,.jpeg,.png"
                            style="opacity: 0; position: absolute; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
                    </div>
                    <p id="fileName2D1"
                        style="text-align: center; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                    </p>
                </div>

                <!-- Image 2 -->
                <div style="flex: 1; min-width: 300px;">
                    <div class="upload-area" id="dropZone2D2" style="height: 120px;">
                        <i class="fa-regular fa-image upload-icon"
                            style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                        <p>Select Image 2</p>
                        <input type="file" name="file2" id="fileInput2D2" accept=".jpg,.jpeg,.png"
                            style="opacity: 0; position: absolute; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
                    </div>
                    <p id="fileName2D2"
                        style="text-align: center; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                    </p>
                </div>
            </div>

            <div style="text-align: center;">
                <button type="submit" class="btn btn-primary" id="compare2DBtn" disabled>Compare Heatmaps</button>
            </div>
        </form>

        <div class="loader" id="loader2D"></div>

        <div id="result2D" style="margin-top: 2rem; display: none;">
            <div style="display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;">
                <!-- Result 1 -->
                <div style="flex: 1; min-width: 300px; text-align: center;">
                    <h4 style="margin-bottom: 0.5rem;">Image 1 Heatmap</h4>
                    <div style="background: #000; border-radius: 8px; overflow: hidden; display: inline-block;">
                        <img id="heatmap1" src="" alt="Heatmap 1"
                            style="max-width: 100%; height: auto; display: block;">
                    </div>
                </div>
                <!-- Result 2 -->
                <div style="flex: 1; min-width: 300px; text-align: center;">
                    <h4 style="margin-bottom: 0.5rem;">Image 2 Heatmap</h4>
                    <div style="background: #000; border-radius: 8px; overflow: hidden; display: inline-block;">
                        <img id="heatmap2" src="" alt="Heatmap 2"
                            style="max-width: 100%; height: auto; display: block;">
                    </div>
                </div>
            </div>
            <p style="text-align: center; color: var(--text-muted); margin-top: 1rem; font-size: 0.9rem;">
                <span style="color: #ef4444;">Red regions</span> indicate high model attention (Tumor).
            </p>
        </div>
    </div>

</div>

<script>
    // --- 3D COMPARISON LOGIC ---
    const f3d1 = document.getElementById('fileInput1');
    const f3d2 = document.getElementById('fileInput2');
    const btn3d = document.getElementById('compare3DBtn');

    function check3D() {
        if (f3d1.files.length > 0 && f3d2.files.length > 0) btn3d.disabled = false;
    }

    f3d1.addEventListener('change', function () {
        if (this.files[0]) document.getElementById('fileName1').textContent = this.files[0].name;
        check3D();
    });
    f3d2.addEventListener('change', function () {
        if (this.files[0]) document.getElementById('fileName2').textContent = this.files[0].name;
        check3D();
    });

    document.getElementById('compare3DForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const loader = document.getElementById('loader3D');
        const container = document.getElementById('result3D');

        loader.style.display = 'block';
        container.style.display = 'none';
        btn3d.disabled = true;

        const formData = new FormData();
        formData.append('file1', f3d1.files[0]);
        formData.append('file2', f3d2.files[0]);

        try {
            const response = await fetch('/api/compare', { method: 'POST', body: formData });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Comparison failed');

            document.getElementById('compareImage3D').src = data.image;
            if (data.slice1 !== undefined && data.slice2 !== undefined) {
                document.getElementById('p1Slice').textContent = `Patient 1: z=${data.slice1}`;
                document.getElementById('p2Slice').textContent = `Patient 2: z=${data.slice2}`;
                document.getElementById('sliceInfo3D').style.display = 'block';
            }
            container.style.display = 'block';
        } catch (err) {
            alert('Error: ' + err.message);
        } finally {
            loader.style.display = 'none';
            btn3d.disabled = false;
        }
    });


    // --- 2D GRAD-CAM LOGIC ---
    const f2d1 = document.getElementById('fileInput2D1');
    const f2d2 = document.getElementById('fileInput2D2');
    const btn2d = document.getElementById('compare2DBtn');

    function check2D() {
        if (f2d1.files.length > 0 && f2d2.files.length > 0) btn2d.disabled = false;
    }

    f2d1.addEventListener('change', function () {
        if (this.files[0]) document.getElementById('fileName2D1').textContent = this.files[0].name;
        check2D();
    });
    f2d2.addEventListener('change', function () {
        if (this.files[0]) document.getElementById('fileName2D2').textContent = this.files[0].name;
        check2D();
    });

    document.getElementById('compare2DForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const loader = document.getElementById('loader2D');
        const container = document.getElementById('result2D');

        loader.style.display = 'block';
        container.style.display = 'none';
        btn2d.disabled = true;

        const formData = new FormData();
        formData.append('file1', f2d1.files[0]);
        formData.append('file2', f2d2.files[0]);

        try {
            const response = await fetch('/api/compare_gradcam', { method: 'POST', body: formData });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Grad-CAM failed');

            document.getElementById('heatmap1').src = data.image1;
            document.getElementById('heatmap2').src = data.image2;
            container.style.display = 'block';
        } catch (err) {
            alert('Error: ' + err.message);
        } finally {
            loader.style.display = 'none';
            btn2d.disabled = false;
        }
    });
</script>
{% endblock %}