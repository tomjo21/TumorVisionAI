{% extends "base.html" %}

{% block title %}3D Segmentation - TumorVision{% endblock %}

{% block content %}
<div class="glass" style="padding: 3rem; border-radius: 20px; max-width: 1000px; margin: 0 auto; margin-top: 2rem;">
    <h2 style="margin-bottom: 2rem; text-align: center;">3D Tumor Segmentation</h2>

    <form id="segmentForm">
        <div class="upload-area" id="dropZone">
            <i class="fa-solid fa-file-medical upload-icon"></i>
            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Drag & Drop NIfTI File (.nii, .nii.gz)</p>
            <p style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 1rem;">(Recommended: <b>FLAIR</b> or <b>T2</b>
                modality for best results)</p>
            <p style="color: var(--text-muted);">or <span
                    style="color: var(--primary); text-decoration: underline;">browse files</span></p>
            <input type="file" name="file" id="fileInput" accept=".nii,.nii.gz"
                style="opacity: 0; position: absolute; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
        </div>

        <div id="fileInfo" style="text-align: center; margin-bottom: 2rem; display: none;">
            <p id="fileName" style="color: var(--text-main); font-weight: 500;"></p>
        </div>

        <div style="text-align: center;">
            <button type="submit" class="btn btn-primary" id="analyzeBtn" disabled>Start Segmentation</button>
        </div>
    </form>

    <div class="loader" id="loader"></div>

    <div id="resultContainer" style="margin-top: 2rem; display: none;">
        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">

            <!-- Slice Viewer -->
            <div class="glass" style="flex: 2; padding: 1.5rem; border-radius: 12px; min-width: 300px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0;">Max Tumor Slice</h4>
                    <span id="sliceIndexDisplay"
                        style="background: rgba(255,255,255,0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem; color: var(--secondary);">z
                        = --</span>
                </div>
                <div style="background: #000; min-height: 400px; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden; position: relative;"
                    id="sliceCanvasContainer">
                    <img id="sliceImage" src="" alt="Segmentation Prediction"
                        style="max-width: 100%; height: auto; display: none;">
                    <div id="slicePlaceholder" style="color: #666;">Processing...</div>
                </div>
            </div>

            <!-- 3D Mesh Viewer -->
            <div class="glass" style="flex: 2; padding: 1.5rem; border-radius: 12px; min-width: 300px;">
                <h4 style="margin-bottom: 1rem;"><i class="fa-solid fa-cube"></i> &nbsp;3D Interactive Model</h4>
                <div id="meshContainer"
                    style="background: #000; height: 400px; border-radius: 8px; overflow: hidden; position: relative;">
                    <!-- Three.js Canvas will go here -->
                </div>
                <div
                    style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; font-size: 0.8rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="width: 12px; height: 12px; background: #ef4444; border-radius: 2px;"></span>
                        Enhancing
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span
                            style="width: 12px; height: 12px; background: rgba(204,204,204,0.3); border: 1px solid #ccc; border-radius: 2px;"></span>
                        Whole Brain
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="width: 12px; height: 12px; background: #eab308; border-radius: 2px;"></span> Edema
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <span style="width: 12px; height: 12px; background: #22d3ee; border-radius: 2px;"></span>
                        Necrotic
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                    Left Click: Rotate | Right Click: Pan
                </div>
            </div>

            <!-- Stats -->
            <div class="glass" style="flex: 1; padding: 1.5rem; border-radius: 12px; min-width: 250px;">
                <h4 style="margin-bottom: 1.5rem;">Tumor Metrics</h4>

                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Total Tumor Volume</p>
                    <p style="font-size: 2rem; font-weight: 700; color: var(--secondary);">
                        <span id="totalVolume">--</span> <span style="font-size: 1rem;">mm続</span>
                    </p>
                </div>

                <div style="margin-bottom: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                    <p style="color: #22d3ee; font-size: 0.9rem; margin-bottom: 0.2rem;">Necrotic / Non-enhancing</p>
                    <p style="font-size: 1.2rem; font-weight: 600;">
                        <span id="necroticVolume">--</span> mm続
                    </p>
                </div>

                <div style="margin-bottom: 1rem;">
                    <p style="color: #eab308; font-size: 0.9rem; margin-bottom: 0.2rem;">Edema</p>
                    <p style="font-size: 1.2rem; font-weight: 600;">
                        <span id="edemaVolume">--</span> mm続
                    </p>
                </div>

                <div style="margin-bottom: 1rem;">
                    <p style="color: #ef4444; font-size: 0.9rem; margin-bottom: 0.2rem;">Enhancing Tumor</p>
                    <p style="font-size: 1.2rem; font-weight: 600;">
                        <span id="enhancingVolume">--</span> mm続
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 3rem; display: flex; gap: 1rem; justify-content: center;">
        <a href="/" class="btn btn-primary" style="background: transparent; border: 1px solid var(--primary);">Upload
            Another</a>

        <button id="downloadReportBtn" class="btn btn-primary"
            style="background: #ef4444; border: none; display: none;">
            <i class="fa-solid fa-file-pdf"></i> &nbsp;Download Medical Report
        </button>
    </div>
</div>
</div>

<!-- Three.js CDN -->
<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
    import { OBJLoader } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/loaders/OBJLoader.js';
    import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

    // Global variables for viewer
    let meshViewer = {
        scene: null, camera: null, renderer: null, controls: null, animationId: null
    };

    function init3DViewer() {
        const container = document.getElementById('meshContainer');
        if (!container) return;
        container.innerHTML = ''; // Clear

        const width = container.clientWidth;
        const height = container.clientHeight;

        // Scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050510);

        // Camera
        const camera = new THREE.PerspectiveCamera(45, width / height, 1, 2000);
        camera.position.set(0, 0, 300);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // Lights
        scene.add(new THREE.AmbientLight(0x404040));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
        dirLight.position.set(1, 1, 1);
        scene.add(dirLight);

        // Animation Loop
        function animate() {
            meshViewer.animationId = requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        meshViewer = { scene, camera, renderer, controls, animationId: meshViewer.animationId };
    }

    // Load Mesh Function
    window.loadMesh = async function (file) {
        const container = document.getElementById('meshContainer');
        if (!container) return;

        container.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#22d3ee;"><i class="fa-solid fa-spinner fa-spin"></i><br>Generating 3D Reconstruction...</div>';

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/mesh', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.error) {
                container.innerHTML = `<div style="text-align:center;padding-top:180px;color:#ef4444;">${data.error}</div>`;
                return;
            }

            if (data.obj) {
                // Initialize scene only after we have data
                init3DViewer();

                const loader = new OBJLoader();
                const object = loader.parse(data.obj);

                // Define clinical materials
                const materials = {
                    "BrainShell": new THREE.MeshPhongMaterial({ color: 0xcccccc, specular: 0x111111, shininess: 10, transparent: true, opacity: 0.15, side: THREE.BackSide }),
                    "Necrotic": new THREE.MeshPhongMaterial({ color: 0x22d3ee, specular: 0x111111, shininess: 30, side: THREE.DoubleSide }),
                    "Edema": new THREE.MeshPhongMaterial({ color: 0xeab308, specular: 0x111111, shininess: 30, side: THREE.DoubleSide }),
                    "Enhancing": new THREE.MeshPhongMaterial({ color: 0xef4444, specular: 0x111111, shininess: 30, side: THREE.DoubleSide })
                };

                object.traverse(function (child) {
                    if (child.isMesh) {
                        const mName = child.name;
                        let matched = false;
                        for (const key in materials) {
                            if (mName.includes(key)) {
                                child.material = materials[key];
                                matched = true;
                                break;
                            }
                            if (child.parent && child.parent.name && child.parent.name.includes(key)) {
                                child.material = materials[key];
                                matched = true;
                                break;
                            }
                        }
                        if (!matched) child.material = materials["Enhancing"];
                    }
                });

                // Box helper to debug visibility
                const box = new THREE.Box3().setFromObject(object);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);

                const scale = 120 / maxDim;
                object.scale.set(scale, scale, scale);
                object.position.set(-center.x * scale, -center.y * scale, -center.z * scale);

                meshViewer.scene.add(object);

            } else {
                container.innerHTML = `<div style="text-align:center;padding-top:180px;color:var(--text-muted);">No 3D data available</div>`;
            }
        } catch (e) {
            console.error("3D Error:", e);
            container.innerHTML = `<div style="text-align:center;padding-top:180px;color:#ef4444;">Error: Connection to Mesh API Failed</div>`;
        }
    };

    window.addEventListener('resize', () => {
        if (meshViewer.renderer && document.getElementById('meshContainer')) {
            const c = document.getElementById('meshContainer');
            meshViewer.renderer.setSize(c.clientWidth, c.clientHeight);
            meshViewer.camera.aspect = c.clientWidth / c.clientHeight;
            meshViewer.camera.updateProjectionMatrix();
        }
    });
</script>
{% endblock %}